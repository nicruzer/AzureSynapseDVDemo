{
	"name": "SQL script 5",
	"properties": {
		"content": {
			"query": "DECLARE @baseKeyCol VARCHAR(1000) = '[name], superName,'\nDECLARE @tableOrViewSchema VARCHAR(255) = 'stage1'\nDECLARE @tableOrViewName VARCHAR(255) = 'vw_marvel_hero_base'\nDECLARE @fqViewName VARCHAR(512) = CONCAT_WS('.',@tableOrViewSchema,@tableOrViewName)\nDECLARE @baseAlias VARCHAR(10) = 'vmhb'\nDECLARE @newLine VARCHAR(2) = CHAR(13) + CHAR(10)\nDECLARE @dropStatement VARCHAR(MAX) =\n    'IF OBJECT_ID(''{{NewViewName}}'') IS NOT NULL ' + @newLine +\n    '   DROP VIEW {{NewViewName}}' + @newLine +\n    ' GO ' + @newLine + @newLine\nDECLARE @createStatement VARCHAR(500) = 'CREATE VIEW {{NewViewName}} AS ' + @newLine\n\nPRINT @dropStatement\n\n;WITH JsonFields AS (\n    SELECT C.COLUMN_NAME, LEFT(C.COLUMN_NAME, 2) AS jAlias,\n        CONCAT_WS('.',@tableOrViewSchema,REPLACE(@tableOrViewName,'_base','_' + C.COLUMN_NAME)) AS NewViewName\n    FROM INFORMATION_SCHEMA.COLUMNS C \n    WHERE C.TABLE_SCHEMA = @tableOrViewSchema\n        AND C.TABLE_NAME = @tableOrViewName\n        AND C.DATA_TYPE = 'NVARCHAR'\n        AND C.CHARACTER_MAXIMUM_LENGTH = -1\n        AND C.CHARACTER_SET_NAME = 'UNICODE'\n)\n\nSELECT CONCAT_WS(\n    ' '\n    ,REPLACE(@dropStatement,'{{NewViewName}}',jf.NewViewName)\n    ,REPLACE(@createStatement,'{{NewViewName}}',jf.NewViewName)\n    ,'SELECT'\n    ,@baseKeyCol\n    ,'jCol.[value] AS ' + jf.COLUMN_NAME + @newLine\n    ,'FROM'\n    ,@fqViewName\n    ,@baseAlias + @newLine\n    ,'CROSS APPLY OPENJSON(' + CONCAT_WS('.',@baseAlias,jf.COLUMN_NAME) + ')' + @newLine\n    ,'WITH ([value] VARCHAR(256) ''$'') AS jCol' + @newLine\n    ,'GO' + @newLine + @newLine\n)\nFROM JsonFields jf\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "azuredvsdp",
				"poolName": "azuredvsdp"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}